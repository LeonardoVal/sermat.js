var Sermat=function __init__(){"use strict";function member(a,b,c,d){d=0|d,Object.defineProperty(a,b,{value:c,writable:4&d,configurable:2&d,enumerable:1&d})}function ownPropDefault(a,b,c){return a.hasOwnProperty(b)?a[b]:c}function identifier(a,b){var c=a.__SERMAT__&&a.__SERMAT__.identifier||a.name||(FUNCTION_ID_RE.exec(a+"")||[])[1];if(!c&&b)throw new Error("Sermat.identifier: Could not found id for type "+a+"!");return c}function record(a){var b="function"==typeof a?identifier(a,!0):a+"";return this.registry[b]}function register(a,b){if("function"!=typeof b.type)throw new Error("Sermat.register: No constructor found for type ("+b+")!");b={type:b.type,identifier:(b.identifier||identifier(b.type,!0)).trim(),serializer:b.serializer,materializer:b.materializer||materializeWithConstructor.bind(this,b.type),global:!!b.global,include:b.include};var c=b.identifier;if(["true","false","null","NaN","Infinity",""].forEach(function(a){if(c===a)throw new Error("Sermat.register: Invalid identifier '"+c+"'!")}),a.hasOwnProperty(c))throw new Error("Sermat.register: Construction '"+c+"' is already registered!");if("function"!=typeof b.serializer)throw new Error("Sermat.register: Serializer for '"+c+"' is not a function!");if("function"!=typeof b.materializer)throw new Error("Sermat.register: Materializer for '"+c+"' is not a function!");return Object.freeze(b),a[c]=b,b.global&&!CONSTRUCTIONS[c]&&(CONSTRUCTIONS[c]=b),b.include&&this.include(b.include),b}function remove(a,b){if(!a.hasOwnProperty(b))throw new Error("Sermat.remove: A construction for '"+b+"' has not been registered!");var c=a[b];return delete a[b],c}function include(a){var b=null;switch(typeof a){case"function":return b=this.record(a),!b&&a.__SERMAT__&&(a.__SERMAT__.type=a,b=this.register(a.__SERMAT__)),b;case"string":return b=this.record(a),!b&&CONSTRUCTIONS[a]&&(b=this.register(CONSTRUCTIONS[a])),b;case"object":if(Array.isArray(a))return a.map(function(a){return this.include(a)}.bind(this));if("function"==typeof a.type)return this.record(a.identifier||a.type)||this.register(a);if(a&&a.__SERMAT__&&a.__SERMAT__.include)return this.include(a.__SERMAT__.include);default:throw new Error("Sermat.include: Could not include ("+a+")!")}}function exclude(a){switch(typeof a){case"string":return this.record(a)?(this.remove(a),1):0;case"function":return this.exclude(identifier(a));case"object":if(Array.isArray(a)){var b=0;return a.forEach(function(a){b+=this.exclude(a)}.bind(this)),b}default:throw new Error("Sermat.exclude: Could not exclude ("+a+")!")}}function serializeAsType(a){return new type(a)}function construct(a,b,c){var d=this.record(a);if(d)return d.materializer.call(this,b,c);throw new SyntaxError("Sermat.construct: Cannot materialize type '"+a+"'")}function materialize(source,bindings){function nextToken(){var a,b,c=LEXER.exec(input);if(text="",c){for(a=c[0].length,input=input.substr(a),offset+=a,b=1,a=TOKENS.length;a>=b;b++)if(c[b]){token=TOKENS.charAt(b-1),text=c[b];break}return text||(token=c[b]||"$"),token}error('Invalid character "'+input.charAt(0)+'"')}function error(a){a=a||"Parse error",offset-=text.length;var b=0,c=0;throw source.substr(0,offset).replace(RE_EOL,function(a,d){return c=d+a.length,b++,""}),new SyntaxError("Sermat.mat: "+a+" at line "+(b+1)+" column "+(offset-c+1)+" (offset "+(offset+1)+")!")}function shift(a){token!==a&&error(),nextToken()}function parseValue(){var t=text;switch(token){case"n":case"s":return nextToken(),eval(t);case"[":return nextToken(),parseArray([]);case"{":return nextToken(),parseObject({});case"b":return parseBind();case"i":return nextToken(),CONSTANTS.hasOwnProperty(t)?CONSTANTS[t]:(shift("("),parseConstruction(t,null));default:error()}}function parseArray(a){if("]"!==token){for(a.push(parseValue());","===token;)nextToken(),a.push(parseValue());shift("]")}else nextToken();return a}function parseObject(a){if("}"!==token){for(parseMember(a);","===token;)nextToken(),parseMember(a);shift("}")}else nextToken();return a}function parseKey(){var t=text;switch(token){case"i":return nextToken(),t;case"s":return nextToken(),eval(t);default:error()}}function parseMember(a){var b=parseKey();return shift(":"),"__proto__"===b?_setProto(a,parseValue()):a[b]=parseValue(),a}function parseBind(){var a=text;if(nextToken(),"="!==token)return bindings[a];switch(bindings.hasOwnProperty(a)&&error("Binding "+a+" cannot be reassigned"),nextToken(),token){case"[":return nextToken(),parseArray(bindings[a]=[]);case"{":return nextToken(),parseObject(bindings[a]={});case"i":var b=text;return nextToken(),shift("("),parseConstruction(b,bindings[a]=construct(b,null,null));default:return bindings[a]=parseValue()}}function parseConstruction(a,b){var c=[];if(")"!==token){for(c.push(parseValue());","===token;)nextToken(),c.push(parseValue());shift(")")}else nextToken();return construct(a,b,c)}bindings=bindings?_setProto({},bindings):{};var input=source+"",offset=0,construct=this.construct.bind(this),token,text;nextToken();var result=parseValue();return shift("$"),result}function serializeAsProperties(a,b,c){var d,e={},f=Array.isArray(b);for(var g in b)d=b[g],c&&!a.hasOwnProperty(d)||(e[f?d:g]=a[d]);return[e]}function materializeWithConstructor(a,b,c){return b||(b=Object.create(a.prototype),c)?(a.apply(b,c),b):b}function sermat(a,b){return this.mat(this.ser(a,b))}function signature(){for(var a,b,c="",d=0;d<arguments.length;d++)b=arguments[d],a=typeof b,d&&(c+=","),c+="object"===a?b?identifier(b.constructor):"":a;return c}function checkSignature(a,b,c,d){var e=signature.apply(this,[c].concat(d));if(!b.exec(e))throw new TypeError("Sermat.checkSignature: Wrong arguments for construction of "+a+" ("+e+")!");return!0}function serialize_Error(a){return[a.message,a.name||"",a.stack||""]}function materializer_Error(a){return function(b,c){var d=null;return c&&(d=new a(c[0]+""),d.name=c[1]+"",d.stack=c[2]+""),d}}function type(a){this.typeConstructor=a}function Sermat(a){var b={},c={};member(this,"registry",b),member(this,"register",register.bind(this,b)),member(this,"remove",remove.bind(this,b)),a=a||{},member(this,"modifiers",c),member(c,"mode",ownPropDefault(a,"mode",BASIC_MODE),5),member(c,"onUndefined",ownPropDefault(a,"onUndefined",TypeError),5),member(c,"autoInclude",ownPropDefault(a,"autoInclude",!0),5),member(c,"useConstructions",ownPropDefault(a,"useConstructions",!0),5),member(c,"climbPrototypes",ownPropDefault(a,"climbPrototypes",!0),5),this.include("Boolean Number String Object Array Date RegExp type".split(" "))}var _getProto=Object.getPrototypeOf||function(a){return a.__proto__},_setProto=Object.setPrototypeOf||function(a,b){return a.__proto__=b,a},_assign=Object.assign||function(a,b){return Object.keys(b).forEach(function(c){a[c]=b[c]}),r},FUNCTION_ID_RE=/^\s*function\s+([\w\$]+)/,ID_REGEXP=/^[a-zA-Z_][a-zA-Z0-9_]*(?:[\.-][a-zA-Z0-9_]+)*$/,BASIC_MODE=0,REPEAT_MODE=1,BINDING_MODE=2,CIRCULAR_MODE=3,serialize=function(){function a(a,e,f){switch(typeof e){case"undefined":return b(a);case"boolean":case"number":return e+"";case"string":return c(e);case"function":case"object":return d(a,e,f)}}function b(b){var c=b.onUndefined;switch(typeof c){case"undefined":return"undefined";case"function":if(c.prototype instanceof Error)throw new c("Sermat.ser: Cannot serialize undefined value!");if(c=c.call(null),"undefined"==typeof c)return"undefined";default:return a(b,c)}}function c(a){return JSON.stringify(a)}function d(b,f,g){if(!f)return"null";if(b.parents.indexOf(f)>=0&&b.mode!==CIRCULAR_MODE)throw new TypeError("Sermat.ser: Circular reference detected!");var h,i,j="";if(b.visited){if(h=b.visited.indexOf(f),h>=0){if(b.mode&BINDING_MODE)return"$"+h;throw new TypeError("Sermat.ser: Repeated reference detected!")}h=b.visited.push(f)-1,b.mode&BINDING_MODE&&(j="$"+h+(b.pretty?" = ":"="))}b.parents.push(f);var k=g&&g+"	";if(Array.isArray(f))j+=e(b,f,g,k);else{var l=_getProto(f);if(f.constructor===Object||!b.useConstructions||b.climbPrototypes&&!l.hasOwnProperty("constructor"))h=0,j+="{"+k,Object.keys(f).forEach(function(d){j+=(h++?","+k:"")+(ID_REGEXP.exec(d)?d:c(d))+(b.pretty?" : ":":")+a(b,f[d],k)}),b.climbPrototypes&&!l.hasOwnProperty("constructor")&&(j+=(h++?","+k:"")+k+"__proto__:"+d(b,l,g)),j+=g+"}";else{var m=b.record(f.constructor)||b.autoInclude&&b.include(f.constructor);if(!m)throw new TypeError('Sermat.ser: Unknown type "'+b.sermat.identifier(f.constructor)+'"!');var n=m.serializer.call(b.sermat,f),o=m.identifier;for(j+=(ID_REGEXP.exec(o)?o:c(o))+"("+k,h=0,i=n.length;i>h;h++)j+=(h?","+k:"")+a(b,n[h],k);j+=g+")"}}return b.parents.pop(),j}function e(b,c,e,f){var g="["+f;if(c.length>0){g+=a(b,c[0],f);for(var h=1,i=c.length;i>h;h++)g+=","+f+a(b,c[h],f)}g+=e+"]";var j=Object.keys(c).filter(isNaN);if(j.length>0){var k={};j.forEach(function(a){k[a]=c[a]}),g="Array("+g+","+d(b,k,f)+")"}return g}return function(b,c){c=c||this.modifiers;var d=ownPropDefault(c,"mode",this.modifiers.mode),e=!!ownPropDefault(c,"pretty",this.modifiers.pretty);return a({visited:d===REPEAT_MODE?null:[],parents:[],sermat:this,record:this.record.bind(this),include:this.include.bind(this),mode:d,onUndefined:ownPropDefault(c,"onUndefined",this.modifiers.onUndefined),autoInclude:ownPropDefault(c,"autoInclude",this.modifiers.autoInclude),useConstructions:ownPropDefault(c,"useConstructions",this.modifiers.useConstructions),climbPrototypes:ownPropDefault(c,"climbPrototypes",this.modifiers.climbPrototypes),pretty:e},b,e?"\n":"")}}(),RE_IGNORABLES=/(?:\s|\/\*(?:[\0-\)+-.0-\uFFFF]*|\*+[\0-\)+-.0-\uFFFF])*\*+\/)*/,RE_NUM=/[+-]?(?:Infinity|\d+(?:\.\d+)?(?:[eE][+-]?\d+)?)/,RE_STR=/\"(?:[^\\\"]|\\[^\n])*\"|``/,RE_ID=/[a-zA-Z_](?:[.-]?[a-zA-Z0-9_]+)*/,RE_BIND=/\$[a-zA-Z0-9_]+(?:[.-]?[a-zA-Z0-9_]+)*/,RE_SYMBOLS=/[\,[\]{:}(=)]/,RE_EOL=/\r\n?|\n/g,LEXER=new RegExp("^"+RE_IGNORABLES.source+"(?:("+RE_NUM.source+")|("+RE_STR.source+")|("+RE_ID.source+")|("+RE_BIND.source+")|("+RE_SYMBOLS.source+")|$)"),TOKENS="nsib",CONSTANTS={undefined:void 0,"true":!0,"false":!1,"null":null,NaN:NaN,Infinity:1/0},CONSTRUCTIONS={};[[Boolean,function(a){return Object.keys(a).length>0?[!!a,_assign({},a)]:[!!a]},function(a,b){return b&&_assign(new Boolean(b[0]),b[1])}],[Number,function(a){return Object.keys(a).length>0?[+a,_assign({},a)]:[+a]},function(a,b){return b&&_assign(new Number(b[0]),b[1])}],[String,function(a){return Object.keys(a).length>0?[a+"",_assign({},a)]:[a+""]},function(a,b){return b&&_assign(new String(b[0]),b[1])}],[Object,function(a){return[a]},function(a,b){return b&&Object.apply(null,b)}],[Array,function(a){return Object.keys(a).length>0?[a,_assign({},a)]:[a]},function(a,b){return b&&_assign(new Array(b[0]),b[1])}],[RegExp,function(a){var b=/^\/(.+?)\/([a-z]*)$/.exec(a+"");return b||raise("serialize_RegExp","Cannot serialize RegExp "+a+"!",{value:a}),Object.keys(a).length>0?[b[1],b[2],_assign({},a)]:[b[1],b[2]]},function(a,b){return b&&checkSignature("RegExp",/^(,string){1,2}(,Object)?$/,a,b)&&_assign(new RegExp(b[0],"string"==typeof b[1]?b[1]:""),"object"==typeof b[1]?b[1]:b[2])}],[Date,function(a){var b=[a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds(),a.getUTCMilliseconds()];return Object.keys(a).length>0&&b.push(_assign({},a)),b},function(a,b){if(b&&checkSignature("Date",/^(,number){1,7}(,Object)?$/,a,b)){var c="object"==typeof b[b.length-1]?b.pop():null;return _assign(new Date(Date.UTC(0|b[0],+b[1]||1,0|b[2],0|b[3],0|b[4],0|b[5],0|b[6])),c)}return null}],[Function,function(a){var b=/^function\s*[\w$]*\s*\(((:?\s*[$\w]+\s*,?)*)\)\s*\{([\0-\uFFFF]*)\}$/.exec(a+"");return b||raise("serialize_Function","Could not serialize Function "+a+"!",{value:a}),Object.keys(a).length>0?[b[1],b[2],_assign({},a)]:[b[1],b[2]]},function(a,b){return b&&checkSignature("Function",/^(,string){2}(,Object)?$/,a,b)&&_assign(new Function(b[0],b[1]),b[2])}],[Error,serialize_Error,materializer_Error(Error)],[EvalError,serialize_Error,materializer_Error(EvalError)],[RangeError,serialize_Error,materializer_Error(RangeError)],[ReferenceError,serialize_Error,materializer_Error(ReferenceError)],[SyntaxError,serialize_Error,materializer_Error(SyntaxError)],[TypeError,serialize_Error,materializer_Error(TypeError)],[URIError,serialize_Error,materializer_Error(URIError)]].forEach(function(a){var b=identifier(a[0],!0);member(CONSTRUCTIONS,b,Object.freeze({identifier:b,type:a[0],serializer:a[1],materializer:a[2]}),1)}),member(CONSTRUCTIONS,"type",type.__SERMAT__=Object.freeze({identifier:"type",type:type,serializer:function(a){var b=this.record(a.typeConstructor);return b?[b.identifier]:void raise("serialize_type",'Unknown type "'+identifier(a.typeConstructor)+'"!',{type:a.typeConstructor})},materializer:function(a,b){if(!b)return null;if(checkSignature("type",/^,string$/,a,b)){var c=this.record(b[0]);if(c)return c.type}raise("materialize_type","Cannot materialize construction for type("+b+")!",{args:b})}}),1);var __members__={BASIC_MODE:BASIC_MODE,REPEAT_MODE:REPEAT_MODE,BINDING_MODE:BINDING_MODE,CIRCULAR_MODE:CIRCULAR_MODE,CONSTRUCTIONS:CONSTRUCTIONS,identifier:identifier,record:record,include:include,exclude:exclude,serialize:serialize,ser:serialize,serializeAsProperties:serializeAsProperties,serializeAsType:serializeAsType,signature:signature,checkSignature:checkSignature,materialize:materialize,mat:materialize,construct:construct,materializeWithConstructor:materializeWithConstructor,sermat:sermat};Object.keys(__members__).forEach(function(a){var b=__members__[a];member(Sermat.prototype,a,b)});var __SINGLETON__=new Sermat;return __SINGLETON__.include(["Date","RegExp"]),Object.keys(__members__).forEach(function(a){var b=__members__[a];member(Sermat,a,"function"==typeof b?b.bind(__SINGLETON__):b)}),["registry","register","remove","modifiers"].forEach(function(a){member(Sermat,a,__SINGLETON__[a])}),member(Sermat,"__package__","sermat"),member(Sermat,"__name__","Sermat"),member(Sermat,"__init__",__init__,4),member(Sermat,"__dependencies__",[],4),Sermat}();
//# sourceMappingURL=sermat-min.js.map