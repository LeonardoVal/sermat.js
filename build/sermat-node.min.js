//! sermat 0.0.10

(function(e){"use strict";module.exports=e()}).call(this,function __init__(){"use strict";function member(e,r,t,n){n|=0,Object.defineProperty(e,r,{value:t,writable:4&n,configurable:2&n,enumerable:1&n})}function _modifier(e,r,t){return e&&e.hasOwnProperty(r)?e[r]:t}var _getProto=Object.getPrototypeOf||function(e){return e.__proto__},_setProto=Object.setPrototypeOf||function(e,r){return e.__proto__=r,e},_assign=Object.assign||function(e,t){return Object.keys(t).forEach(function(r){e[r]=t[r]}),r},_isArray=Array.isArray,FUNCTION_ID_RE=/^\s*function\s+([\w\$]+)/,ID_REGEXP=/^[a-zA-Z_][a-zA-Z0-9_]*(?:[\.-][a-zA-Z0-9_]+)*$/,INVALID_ID_RE=/^(true|false|null|undefined|NaN|Infinity|\$[\w\$]*)$/;function identifier(e,r){var t=e.__SERMAT__&&e.__SERMAT__.identifier||e.name||(FUNCTION_ID_RE.exec(e+"")||[])[1];if(!t&&r)throw new Error("Sermat.identifier: Could not found id for type "+e+"!");return t}function record(e){var r="function"==typeof e?identifier(e,!0):e+"";return this.registry[r]}function register(e,r){if("function"!=typeof r.type)throw new Error("Sermat.register: No constructor found for type ("+r+")!");var t=(r={type:r.type,identifier:(r.identifier||identifier(r.type,!0)).trim(),serializer:r.serializer||serializeWithConstructor.bind(this,r.type),materializer:r.materializer||materializeWithConstructor.bind(this,r.type),global:!!r.global,include:r.include}).identifier;if(INVALID_ID_RE.test(t))throw new Error("Sermat.register: Invalid identifier '"+t+"'!");if(e.hasOwnProperty(t))throw new Error("Sermat.register: Construction '"+t+"' is already registered!");if("function"!=typeof r.serializer)throw new Error("Sermat.register: Serializer for '"+t+"' is not a function!");if("function"!=typeof r.materializer)throw new Error("Sermat.register: Materializer for '"+t+"' is not a function!");return Object.freeze(r),e[t]=r,r.global&&!CONSTRUCTIONS[t]&&(CONSTRUCTIONS[t]=r),r.include&&this.include(r.include),r}function remove(e,r){if(!e.hasOwnProperty(r))throw new Error("Sermat.remove: A construction for '"+r+"' has not been registered!");var t=e[r];return delete e[r],t}function include(e){var r=null;switch(typeof e){case"function":return!(r=this.record(e))&&e.__SERMAT__&&(r=e.__SERMAT__,e.hasOwnProperty("__SERMAT__")||r.inheritable||((r=Object.assign({},r)).identifier=this.identifier(e,!0)),r.type=e,r=this.register(r)),r;case"string":return!(r=this.record(e))&&CONSTRUCTIONS[e]&&(r=this.register(CONSTRUCTIONS[e])),r;case"object":if(Array.isArray(e))return e.map(function(e){return this.include(e)}.bind(this));if("function"==typeof e.type)return this.record(e.identifier||e.type)||this.register(e);if(e&&e.__SERMAT__&&e.__SERMAT__.include)return this.include(e.__SERMAT__.include);default:throw new Error("Sermat.include: Could not include ("+e+")!")}}function exclude(e){switch(typeof e){case"string":return this.record(e)?(this.remove(e),1):0;case"function":return this.exclude(identifier(e));case"object":if(Array.isArray(e)){var r=0;return e.forEach(function(e){r+=this.exclude(e)}.bind(this)),r}default:throw new Error("Sermat.exclude: Could not exclude ("+e+")!")}}var BASIC_MODE=0,REPEAT_MODE=1,BINDING_MODE=2,CIRCULAR_MODE=3;function serialize(e,r){var t=this,n=_modifier(r,"mode",this.modifiers.mode),i=_modifier(r,"pretty",this.modifiers.pretty),o=_modifier(r,"onUndefined",this.modifiers.onUndefined),s=_modifier(r,"autoInclude",this.modifiers.autoInclude),a=_modifier(r,"useConstructions",this.modifiers.useConstructions),u=_modifier(r,"climbPrototypes",this.modifiers.climbPrototypes),c=n===REPEAT_MODE?null:[],f=[],_=i?" : ":":",l=i?" = ":"=";function E(e,r){switch(typeof e){case"undefined":return function(){switch(typeof o){case"undefined":return"undefined";case"function":if(o.prototype instanceof Error)throw new o("Sermat.ser: Cannot serialize undefined value!");var e=o.call(null);return void 0===e?"undefined":E(e);default:return E(o)}}();case"boolean":case"number":return e+"";case"string":return d(e);case"function":return function(e,r){var n=t.identifier(e,!1)?t.record(e):null;return n?"$"+n.identifier:m(e,r)}(e,r);case"object":return m(e,r)}}function d(e){return JSON.stringify(e)}function m(e,r){if(!e)return"null";if(f.indexOf(e)>=0&&n!==CIRCULAR_MODE)throw new TypeError("Sermat.ser: Circular reference detected!");var i,o="";if(c){if((i=c.indexOf(e))>=0){if(n&BINDING_MODE)return"$"+i;throw new TypeError("Sermat.ser: Repeated reference detected!")}i=c.push(e)-1,n&BINDING_MODE&&(o="$"+i+l)}f.push(e);var E=r&&r+"\t";if(_isArray(e))o+=function(e,r,t){return"["+t+h(e,r,t)+r+"]"}(e,r,E);else{var p=_getProto(e),b="";if(e.constructor===Object||!a||u&&!p.hasOwnProperty("constructor"))b=h(e,r,E),u&&!p.hasOwnProperty("constructor")&&(b+=(b?","+E:"")+"__proto__"+_+m(p,r)),o+="{"+E+b+r+"}";else{var O=t.record(e.constructor)||s&&t.include(e.constructor);if(!O)throw new TypeError('Sermat.ser: Unknown type "'+t.identifier(e.constructor)+'"!');var y=O.serializer.call(t,e),g=O.identifier;Array.isArray(y)?o+=(ID_REGEXP.exec(g)?g:d(g))+"("+E+h(y,r,E)+r+")":o+=m(y,r)}}return f.pop(),o}function h(e,r,t){var n="",i=","+t,o=0,s=Array.isArray(e),a=s?e.length:0;if(a>0)for(n+=E(e[o],t),o++;o<a;o++)n+=i+E(e[o],t);return Object.keys(e).forEach(function(r){s&&(0|r)-r==0||(o>0&&(n+=i),n+=(ID_REGEXP.exec(r)?r:d(r))+_+E(e[r],t),o++)}),n}return E(e,i?"\n":"")}function construct(e,r,t){var n=this.record(e);if(n)return n.materializer.call(this,r,t);throw new SyntaxError("Sermat.construct: Cannot materialize type '"+e+"'")}var RE_IGNORABLES=/(?:\s|\/\*(?:[^*]*|\n|\*+[^\/])*\*+\/)*/,RE_NUM=/[+-]?\d+(?:\.\d+)?(?:[eE][+-]?\d+)?|[+-]Infinity/,RE_STR=/\"(?:[^\\\"\r\n]|\\[^\r\n])*\"/,RE_STR2=/(?:`(?:[^`]|[\r\n])*`)+/,RE_CONS=/(?:true|false|null|undefined|Infinity|NaN)\b/,RE_ID=/[a-zA-Z_]+(?:[.-]?[a-zA-Z0-9_])*/,RE_BIND=/\$(?:[.-]?[a-zA-Z0-9_])*/,RE_SYMBOLS=/[,:[\]{}()=]/,RE_EOL=/\r\n?|\n/g,LEXER=new RegExp("^"+RE_IGNORABLES.source+"(?:("+RE_NUM.source+")|("+RE_STR.source+")|("+RE_STR2.source+")|("+RE_CONS.source+")|("+RE_ID.source+")|("+RE_BIND.source+")|("+RE_SYMBOLS.source+")|$)"),LEX_EOI=0,LEX_NUM=1,LEX_STR=2,LEX_STR2=3,LEX_CONS=4,LEX_ID=5,LEX_BIND=6,LEX_COMMA=7,LEX_COLON=8,LEX_OBRACKET=9,LEX_CBRACKET=10,LEX_OBRACE=11,LEX_CBRACE=12,LEX_OPAREN=13,LEX_CPAREN=14,LEX_EQUAL=15;function materialize(source,modifiers){var input=source,offset=0,token=-1,text="",bindings=modifiers&&modifiers.bindings||{},sermat=this;function nextToken(){var e,r,t;if(e=LEXER.exec(input)){for(r=e[0].length,input=input.substr(r),offset+=r,text="",t=1,r=e.length-1;t<r;t++)if(e[t])return text=e[t],token=t;return text=e[t],token=(token=",:[]{}()=".indexOf(text))<0?LEX_EOI:token+LEX_COMMA}error('Invalid character "'+input.charAt(0)+'"')}function error(e){e=e||"Parse error",offset-=text.length;var r=0,t=0;throw source.substr(0,offset).replace(RE_EOL,function(e,n){return t=n+e.length,r++,""}),new SyntaxError("Sermat.mat: "+e+" at line "+(r+1)+" column "+(offset-t)+" (offset "+(offset+1)+")!")}function shift(e){token!==e&&error("Parse error. Expected <"+e+"> but got <"+(text||token)+">"),nextToken()}function parseValue(){var t=text;switch(token){case LEX_NUM:case LEX_STR:return nextToken(),eval(t);case LEX_STR2:return nextToken(),t.substr(1,t.length-2).replace(/``/g,"`");case LEX_OBRACKET:return nextToken(),parseArray([]);case LEX_OBRACE:return nextToken(),parseObject({});case LEX_BIND:return parseBind();case LEX_CONS:return nextToken(),eval(t);case LEX_ID:return nextToken(),shift(LEX_OPAREN),parseConstruction(t,null);default:error("Expected value but got `"+t+"` (token="+token+")!")}}function parseArray(e){return token!==LEX_CBRACKET&&parseElements(e),shift(LEX_CBRACKET),e}function parseObject(e){return token!==LEX_CBRACE&&parseElements(e),shift(LEX_CBRACE),e}function parseElements(obj){for(var i=0,t;;){switch(t=text,token){case LEX_CONS:obj[i++]=eval(t),nextToken();break;case LEX_ID:switch(nextToken()){case LEX_COLON:nextToken(),"__proto__"===t?_setProto(obj,parseValue()):obj[t]=parseValue();break;case LEX_OPAREN:nextToken(),obj[i++]=parseConstruction(t,null);break;default:error()}break;case LEX_STR:nextToken()===LEX_COLON?(nextToken(),"__proto__"===t?_setProto(obj,parseValue()):obj[eval(t)]=parseValue()):obj[i++]=eval(t);break;case LEX_NUM:obj[i++]=eval(t),nextToken();break;case LEX_BIND:obj[i++]=parseBind();break;case LEX_STR2:case LEX_OBRACKET:case LEX_OBRACE:obj[i++]=parseValue();break;default:error("Expected element but got `"+t+"` (token="+token+", input='"+input+"')!")}if(token!==LEX_COMMA)break;nextToken()}return obj}function parseBind(){var e=text;if(nextToken(),token!==LEX_EQUAL){if(bindings.hasOwnProperty(e))return bindings[e];var r=sermat.record(e.substr(1));if(r)return r.type;throw new ReferenceError("Sermat.mat: "+e+" is not defined!")}switch(bindings.hasOwnProperty(e)&&error("Binding "+e+" cannot be reassigned"),nextToken(),token){case LEX_OBRACKET:return nextToken(),parseArray(bindings[e]=[]);case LEX_OBRACE:return nextToken(),parseObject(bindings[e]={});case LEX_ID:var t=text;return nextToken(),shift(LEX_OPAREN),bindings[e]=parseConstruction(t,bindings[e]=sermat.construct(t,null,null));default:return bindings[e]=parseValue()}}function parseConstruction(e,r){var t=[];return token!==LEX_CPAREN&&parseElements(t),shift(LEX_CPAREN),sermat.construct(e,r,t)}nextToken();var result=parseValue();return shift(LEX_EOI),result}function serializeAsProperties(e,r,t){var n,i={},o=Array.isArray(r);for(var s in r)n=r[s],t&&!e.hasOwnProperty(n)||(i[o?n:s]=e[n]);return[i]}function serializeWithConstructor(e,r){var t=e+"",n=/^function\s*[\w$]*\s*\(([^)]*)\)\s*\{/.exec(t)||/^\(([^)]*)\)\s*=>/.exec(t);if(n&&n[1])return n[1].split(/\s*,\s*/).map(function(e){return r[e]});throw new TypeError("Cannot infer a serialization from constructor ("+e+")!")}function materializeWithConstructor(e,r,t){return r||(r=Object.create(e.prototype),t)?(e.apply(r,t),r):r}function sermat(e,r){return this.mat(this.ser(e,r))}function clone(e,r){var t=this,n=[],i=[],o=_modifier(r,"useConstructions",this.modifiers.useConstructions),s=_modifier(r,"autoInclude",this.modifiers.autoInclude),a=_modifier(r,"climbPrototypes",this.modifiers.climbPrototypes);function u(e){switch(typeof e){case"undefined":case"boolean":case"number":case"string":case"function":return e;case"object":if(null===e)return null;var r=n.indexOf(e);return r>=0?i[r]:function e(r){n.push(r);var c,f=Array.isArray(r);if(f||r.constructor===Object||!o){if(c=f?[]:{},a){var _=_getProto(r);_.hasOwnProperty("constructor")||_setProto(c,e(_))}i.push(c),Object.keys(r).forEach(function(e){c[e]=u(r[e])})}else{var l=t.record(r.constructor)||s&&t.include(r.constructor);if(!l)throw new TypeError('Sermat.clone: Unknown type "'+t.identifier(r.constructor)+'"!');c=l.materializer.call(t,null,null),i.push(c);var E=i.length-1,d=l.serializer.call(t,r).map(u);c=l.materializer.call(t,c,d),i[E]=c}return c}(e);default:throw new Error("Unsupported type "+typeof e+"!")}}return u(e)}function hashCode(e,r){var t=this,n=[],i=[],o=_modifier(r,"useConstructions",this.modifiers.useConstructions),s=_modifier(r,"autoInclude",this.modifiers.autoInclude),a=_modifier(r,"climbPrototypes",this.modifiers.climbPrototypes);function u(e){var r,c;switch(typeof e){case"undefined":case"boolean":case"number":return e>>>0;case"string":var f=5381;for(r=0,c=31&e.length;r<c;r++)f=33*f^e.charCodeAt(r);return f>>>0;case"function":case"object":return null===e?0:(r=n.indexOf(e))>=0?i[r]:function e(r){var c=1,f=n.push(r);if(i.push(0),!Array.isArray(r)&&r.constructor!==Object&&o){var _=t.record(r.constructor)||s&&t.include(r.constructor);if(!_)throw new TypeError('Sermat.hashCode: Unknown type "'+t.identifier(r.constructor)+'"!');return e(_.serializer.call(t,r))}if(a){var l=_getProto(r);l.hasOwnProperty("constructor")||(c=e(l))}var E=[];for(var d in r)E.push(u(d)^u(r[d]));return E.sort(function(e,r){return e-r}).forEach(function(e){c=31*c+e|0}),i[f]=c,c}(e);default:throw new Error("Unsupported type "+typeof e+"!")}}return u(e)}function signature(){for(var e,r,t="",n=0;n<arguments.length;n++)e=typeof(r=arguments[n]),n&&(t+=","),t+="object"===e?r?identifier(r.constructor):"":e;return t}function checkSignature(e,r,t,n){var i=signature.apply(this,[t].concat(n));if(!r.exec(i))throw new TypeError("Sermat.checkSignature: Wrong arguments for construction of "+e+" ("+i+")!");return!0}var CONSTRUCTIONS={},FUNCTION_RE=/^(function\s*[\w$]*\s*\((?:\s*[$\w]+\s*,?)*\)\s*\{[\0-\uFFFF]*\}|\((?:\s*[$\w]+\s*,?)*\)\s*=>\s*[\0-\uFFFF]*)$/;function serialize_Error(e){return[e.message,e.name||"",e.stack||""]}function materializer_Error(e){return function(r,t){var n=null;return t&&((n=new e(t[0]+"")).name=t[1]+"",n.stack=t[2]+""),n}}function Sermat(e){var r={},t={};member(this,"registry",r),member(this,"register",register.bind(this,r)),member(this,"remove",remove.bind(this,r)),e=e||{},member(this,"modifiers",t),member(t,"mode",_modifier(e,"mode",BASIC_MODE),5),member(t,"onUndefined",_modifier(e,"onUndefined",TypeError),5),member(t,"autoInclude",_modifier(e,"autoInclude",!0),5),member(t,"useConstructions",_modifier(e,"useConstructions",!0),5),member(t,"climbPrototypes",_modifier(e,"climbPrototypes",!0),5),this.include("Boolean Number String Object Array Date RegExp".split(" "))}[[Boolean,function(e){return _assign([e.valueOf()],e)},function(e,r){return r&&_assign(new Boolean(r.shift()),r)}],[Number,function(e){return _assign([e.valueOf()],e)},function(e,r){return r&&_assign(new Number(r.shift()),r)}],[String,function(e){var r=[""+e.valueOf()];e.length;return Object.keys(e).forEach(function(t){if((0|t)-t!=0)r[t]=e[t];else if(+t<0||+t>=e.length)throw new TypeError("Sermat.ser: Cannot serialize String instances with integer properties (like <"+t+">)!")}),r},function(e,r){return r&&_assign(new String(r.shift()),r)}],[Object,function(e){throw new TypeError("Sermat.ser: Object literals should not be serialized by a construction!")},function(e,r){return r&&Object.apply(null,r)}],[Array,function(e){throw new TypeError("Sermat.ser: Arrays should not be serialized by a construction!")},function(e,r){return r}],[RegExp,function(e){var r=/^\/(.+?)\/([a-z]*)$/.exec(e+"");return r||raise("serialize_RegExp","Cannot serialize RegExp "+e+"!",{value:e}),_assign([r[1],r[2]],e)},function(e,r){return r&&checkSignature("RegExp",/^(,string){1,2}$/,e,r)&&_assign(new RegExp(r.shift(),r.shift()),r)}],[Date,function(e){return _assign([e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds()],e)},function(e,r){return r&&checkSignature("Date",/^(,number){1,7}?$/,e,r)?_assign(new Date(Date.UTC(0|r.shift(),+r.shift()||1,0|r.shift(),0|r.shift(),0|r.shift(),0|r.shift(),0|r.shift())),r):null}],[Function,function(e){var r=e+"";if(!FUNCTION_RE.test(r))throw new TypeError("Could not serialize function ("+r+")!");return _assign([r],e)},function materialize_Function(obj,args){if(args&&checkSignature("Function",/^,string$/,obj,args)){if(FUNCTION_RE.test(args[0]))return _assign(eval("("+args.shift()+")"),args);throw new ParseError("Invalid source for Function ("+args[0]+")!")}return null}],[Error,serialize_Error,materializer_Error(Error)],[EvalError,serialize_Error,materializer_Error(EvalError)],[RangeError,serialize_Error,materializer_Error(RangeError)],[ReferenceError,serialize_Error,materializer_Error(ReferenceError)],[SyntaxError,serialize_Error,materializer_Error(SyntaxError)],[TypeError,serialize_Error,materializer_Error(TypeError)],[URIError,serialize_Error,materializer_Error(URIError)]].forEach(function(e){var r=identifier(e[0],!0);member(CONSTRUCTIONS,r,Object.freeze({identifier:r,type:e[0],serializer:e[1],materializer:e[2]}),1)});var __members__={BASIC_MODE:BASIC_MODE,REPEAT_MODE:REPEAT_MODE,BINDING_MODE:BINDING_MODE,CIRCULAR_MODE:CIRCULAR_MODE,CONSTRUCTIONS:CONSTRUCTIONS,identifier:identifier,record:record,include:include,exclude:exclude,serialize:serialize,ser:serialize,serializeAsProperties:serializeAsProperties,signature:signature,checkSignature:checkSignature,materialize:materialize,mat:materialize,construct:construct,materializeWithConstructor:materializeWithConstructor,sermat:sermat,clone:clone,hashCode:hashCode};Object.keys(__members__).forEach(function(e){var r=__members__[e];member(Sermat.prototype,e,r)});var __SINGLETON__=new Sermat;return __SINGLETON__.include(["Date","RegExp"]),Object.keys(__members__).forEach(function(e){var r=__members__[e];member(Sermat,e,"function"==typeof r?r.bind(__SINGLETON__):r)}),["registry","register","remove","modifiers"].forEach(function(e){member(Sermat,e,__SINGLETON__[e])}),member(Sermat,"__package__","sermat"),member(Sermat,"__name__","Sermat"),member(Sermat,"__init__",__init__,4),member(Sermat,"__dependencies__",[],4),Sermat});
//# sourceMappingURL=sermat-node.min.js.map